name: ğŸ“Š æ¯æ—¥è‚¡ç¥¨åˆ†æ

on:
  # å®šæ—¶è§¦å‘ï¼šæ¯å¤©æ—©ä¸Š8ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
  schedule:
    - cron: '0 0 * * *'  # UTC 0:00 = åŒ—äº¬æ—¶é—´ 8:00
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'æµ‹è¯•æ¨¡å¼ï¼ˆåªåˆ†æä¸€åªè‚¡ç¥¨ï¼‰'
        required: false
        default: 'false'
        type: boolean

jobs:
  stock-analysis:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ğŸ“Š æ‰§è¡Œè‚¡ç¥¨åˆ†æ
      env:
        DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        TUSHARE_TOKEN: ${{ secrets.TUSHARE_TOKEN }}
      run: |
        if [ "${{ github.event.inputs.test_mode }}" = "true" ]; then
          echo "ğŸ§ª æµ‹è¯•æ¨¡å¼ï¼šåˆ†æå•åªè‚¡ç¥¨"
          python main.py --stock 600519.SH
        else
          echo "ğŸ“Š æ­£å¼æ¨¡å¼ï¼šåˆ†æè‚¡ç¥¨æ± "
          python main.py --watchlist
        fi
        
    - name: ğŸ“¦ ä¸Šä¼ æŠ¥å‘Šæ–‡ä»¶
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: stock-analysis-reports-${{ github.run_number }}
        path: |
          reports/*.md
          reports/*.json
        retention-days: 30
        
    - name: ğŸ“Š æäº¤æŠ¥å‘Šåˆ°ä»“åº“
      if: success()
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add reports/
        if git diff --staged --quiet; then
          echo "ğŸ“ æ²¡æœ‰æ–°çš„æŠ¥å‘Šæ–‡ä»¶éœ€è¦æäº¤"
        else
          git commit -m "ğŸ“Š è‡ªåŠ¨ç”Ÿæˆè‚¡ç¥¨åˆ†ææŠ¥å‘Š - $(date +'%Y-%m-%d %H:%M:%S')"
          git push
        fi
        
    - name: ğŸ“§ åˆ›å»ºåˆ†ææŠ¥å‘ŠIssue
      if: success()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          // æŸ¥æ‰¾æœ€æ–°çš„æ±‡æ€»æŠ¥å‘Š
          const reportsDir = 'reports';
          const files = fs.readdirSync(reportsDir);
          const summaryFiles = files.filter(f => f.startsWith('summary_') && f.endsWith('.md'));
          
          if (summaryFiles.length === 0) {
            console.log('æ²¡æœ‰æ‰¾åˆ°æ±‡æ€»æŠ¥å‘Š');
            return;
          }
          
          const latestSummary = summaryFiles.sort().pop();
          const summaryPath = path.join(reportsDir, latestSummary);
          const summaryContent = fs.readFileSync(summaryPath, 'utf8');
          
          // æå–å…³é”®ä¿¡æ¯
          const lines = summaryContent.split('\n');
          let tableContent = '';
          let inTable = false;
          
          for (const line of lines) {
            if (line.includes('| è‚¡ç¥¨ä»£ç  |')) {
              inTable = true;
              tableContent += line + '\n';
            } else if (inTable && line.startsWith('|') && !line.includes('---')) {
              tableContent += line + '\n';
            } else if (inTable && !line.startsWith('|')) {
              break;
            }
          }
          
          const today = new Date().toLocaleDateString('zh-CN');
          const issueTitle = `ğŸ“Š æ¯æ—¥è‚¡ç¥¨åˆ†ææŠ¥å‘Š - ${today}`;
          
          const issueBody = `## ğŸ“Š ä»Šæ—¥è‚¡ç¥¨åˆ†æå®Œæˆï¼
          
**åˆ†ææ—¶é—´**: ${today}
**è¿è¡ŒID**: #${{ github.run_number }}

### ğŸ“ˆ åˆ†æç»“æœæ¦‚è§ˆ

${tableContent}

### ğŸ“ è¯¦ç»†æŠ¥å‘Š

- ğŸ“‹ [æ±‡æ€»æŠ¥å‘Š](https://github.com/${{ github.repository }}/blob/main/${summaryPath})
- ğŸ“¦ [ä¸‹è½½æ‰€æœ‰æŠ¥å‘Š](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

### ğŸ¤– ç³»ç»Ÿä¿¡æ¯

- **AIæ¨¡å‹**: DeepSeek
- **æ•°æ®æº**: Tushare  
- **è¿è¡ŒçŠ¶æ€**: âœ… æˆåŠŸ
- **ä¸‹æ¬¡è¿è¡Œ**: æ˜å¤© 08:00

---

> ğŸ’¡ **æç¤º**: ç‚¹å‡»ä¸Šæ–¹é“¾æ¥æŸ¥çœ‹è¯¦ç»†åˆ†ææŠ¥å‘Šï¼Œæˆ–åœ¨Actionsé¡µé¢ä¸‹è½½å®Œæ•´æŠ¥å‘Šæ–‡ä»¶ã€‚

> âš ï¸ **é£é™©æç¤º**: æœ¬æŠ¥å‘Šä»…ä¾›å‚è€ƒï¼Œä¸æ„æˆæŠ•èµ„å»ºè®®ã€‚æŠ•èµ„æœ‰é£é™©ï¼Œå†³ç­–éœ€è°¨æ…ã€‚`;

          // åˆ›å»ºIssue
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: issueTitle,
            body: issueBody,
            labels: ['ğŸ“Š åˆ†ææŠ¥å‘Š', 'ğŸ¤– è‡ªåŠ¨ç”Ÿæˆ']
          });
          
          console.log('âœ… Issueåˆ›å»ºæˆåŠŸ');
          
    - name: ğŸ“§ å‘é€å¤±è´¥é€šçŸ¥
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          const today = new Date().toLocaleDateString('zh-CN');
          const issueTitle = `âŒ è‚¡ç¥¨åˆ†æå¤±è´¥ - ${today}`;
          
          const issueBody = `## âŒ ä»Šæ—¥è‚¡ç¥¨åˆ†æå¤±è´¥
          
**å¤±è´¥æ—¶é—´**: ${today}
**è¿è¡ŒID**: #${{ github.run_number }}

### ğŸ” æ•…éšœä¿¡æ¯

è¯·æ£€æŸ¥ä»¥ä¸‹å¯èƒ½çš„åŸå› ï¼š

1. **APIå¯†é’¥é—®é¢˜**: DeepSeekæˆ–Tushare APIå¯†é’¥å¯èƒ½è¿‡æœŸ
2. **ç½‘ç»œé—®é¢˜**: APIæœåŠ¡å¯èƒ½æš‚æ—¶ä¸å¯ç”¨  
3. **ä»£ç é”™è¯¯**: å¯èƒ½å­˜åœ¨ä»£ç bug
4. **é…é¢é™åˆ¶**: APIè°ƒç”¨å¯èƒ½è¶…å‡ºé™åˆ¶

### ğŸ“‹ æ’æŸ¥æ­¥éª¤

1. æŸ¥çœ‹ [Actionsæ—¥å¿—](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
2. æ£€æŸ¥Secretsä¸­çš„APIå¯†é’¥æ˜¯å¦æ­£ç¡®
3. ç¡®è®¤APIæœåŠ¡çŠ¶æ€æ˜¯å¦æ­£å¸¸
4. å¦‚é—®é¢˜æŒç»­ï¼Œè¯·æ‰‹åŠ¨è¿è¡Œæµ‹è¯•

---

> ğŸ”§ **å»ºè®®**: å¯ä»¥æ‰‹åŠ¨è§¦å‘å·¥ä½œæµè¿›è¡Œæµ‹è¯•ï¼Œæˆ–ç­‰å¾…ä¸‹æ¬¡è‡ªåŠ¨è¿è¡Œã€‚`;

          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: issueTitle,
            body: issueBody,
            labels: ['âŒ é”™è¯¯', 'ğŸ¤– è‡ªåŠ¨ç”Ÿæˆ', 'ğŸš¨ éœ€è¦å…³æ³¨']
          });
          
          console.log('âœ… å¤±è´¥é€šçŸ¥Issueåˆ›å»ºæˆåŠŸ');
