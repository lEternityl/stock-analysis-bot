name: ğŸ“Š æ¯æ—¥è‚¡ç¥¨åˆ†æ

on:
  schedule:
    - cron: '0 0 * * *'  # UTC 0:00 = åŒ—äº¬æ—¶é—´ 8:00
  
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'æµ‹è¯•æ¨¡å¼ï¼ˆåªåˆ†æä¸€åªè‚¡ç¥¨ï¼‰'
        required: false
        default: 'false'
        type: boolean

jobs:
  stock-analysis:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ğŸ“Š æ‰§è¡Œè‚¡ç¥¨åˆ†æ
      env:
        DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        TUSHARE_TOKEN: ${{ secrets.TUSHARE_TOKEN }}
      run: |
        if [ "${{ github.event.inputs.test_mode }}" = "true" ]; then
          echo "ğŸ§ª æµ‹è¯•æ¨¡å¼ï¼šåˆ†æå•åªè‚¡ç¥¨"
          python main.py --stock 600519.SH
        else
          echo "ğŸ“Š æ­£å¼æ¨¡å¼ï¼šåˆ†æè‚¡ç¥¨æ± "
          python main.py --watchlist
        fi
        
    - name: ğŸ“¦ ä¸Šä¼ æŠ¥å‘Šæ–‡ä»¶
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: stock-analysis-reports-${{ github.run_number }}
        path: |
          reports/*.md
          reports/*.json
        retention-days: 30
        
    - name: ğŸ“Š æäº¤æŠ¥å‘Šåˆ°ä»“åº“
      if: success()
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add reports/
        if git diff --staged --quiet; then
          echo "ğŸ“ æ²¡æœ‰æ–°çš„æŠ¥å‘Šæ–‡ä»¶éœ€è¦æäº¤"
        else
          git commit -m "ğŸ“Š è‡ªåŠ¨ç”Ÿæˆè‚¡ç¥¨åˆ†ææŠ¥å‘Š - $(date +'%Y-%m-%d %H:%M:%S')"
          git push
        fi
        
    - name: ğŸ“§ åˆ›å»ºæˆåŠŸé€šçŸ¥Issue
      if: success()
      uses: actions/github-script@v7
      with:
        script: |
          const today = new Date().toLocaleDateString('zh-CN');
          const runNumber = '${{ github.run_number }}';
          const runId = '${{ github.run_id }}';
          const repo = '${{ github.repository }}';
          
          const issueTitle = 'ğŸ“Š æ¯æ—¥è‚¡ç¥¨åˆ†ææŠ¥å‘Š - ' + today;
          const issueBody = '## ğŸ“Š ä»Šæ—¥è‚¡ç¥¨åˆ†æå®Œæˆï¼\n\n' +
            '**åˆ†ææ—¶é—´**: ' + today + '\n' +
            '**è¿è¡ŒID**: #' + runNumber + '\n\n' +
            '### ğŸ“ è¯¦ç»†æŠ¥å‘Š\n\n' +
            '- ğŸ“¦ [ä¸‹è½½æ‰€æœ‰æŠ¥å‘Š](https://github.com/' + repo + '/actions/runs/' + runId + ')\n' +
            '- ğŸ“‹ æŸ¥çœ‹ä»“åº“ä¸­çš„reportsç›®å½•è·å–è¯¦ç»†æŠ¥å‘Š\n\n' +
            '### ğŸ¤– ç³»ç»Ÿä¿¡æ¯\n\n' +
            '- **AIæ¨¡å‹**: DeepSeek\n' +
            '- **æ•°æ®æº**: Tushare\n' +
            '- **è¿è¡ŒçŠ¶æ€**: âœ… æˆåŠŸ\n' +
            '- **ä¸‹æ¬¡è¿è¡Œ**: æ˜å¤© 08:00\n\n' +
            '---\n\n' +
            '> ğŸ’¡ **æç¤º**: åœ¨Actionsé¡µé¢ä¸‹è½½å®Œæ•´æŠ¥å‘Šæ–‡ä»¶ã€‚\n\n' +
            '> âš ï¸ **é£é™©æç¤º**: æœ¬æŠ¥å‘Šä»…ä¾›å‚è€ƒï¼Œä¸æ„æˆæŠ•èµ„å»ºè®®ã€‚æŠ•èµ„æœ‰é£é™©ï¼Œå†³ç­–éœ€è°¨æ…ã€‚';

          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: issueTitle,
            body: issueBody,
            labels: ['ğŸ“Š åˆ†ææŠ¥å‘Š', 'ğŸ¤– è‡ªåŠ¨ç”Ÿæˆ']
          });
          
          console.log('âœ… æˆåŠŸé€šçŸ¥Issueåˆ›å»ºå®Œæˆ');
          
    - name: ğŸ“§ åˆ›å»ºå¤±è´¥é€šçŸ¥Issue
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          const today = new Date().toLocaleDateString('zh-CN');
          const runNumber = '${{ github.run_number }}';
          const runId = '${{ github.run_id }}';
          const repo = '${{ github.repository }}';
          
          const issueTitle = 'âŒ è‚¡ç¥¨åˆ†æå¤±è´¥ - ' + today;
          const issueBody = '## âŒ ä»Šæ—¥è‚¡ç¥¨åˆ†æå¤±è´¥\n\n' +
            '**å¤±è´¥æ—¶é—´**: ' + today + '\n' +
            '**è¿è¡ŒID**: #' + runNumber + '\n\n' +
            '### ğŸ” æ•…éšœä¿¡æ¯\n\n' +
            'è¯·æ£€æŸ¥ä»¥ä¸‹å¯èƒ½çš„åŸå› ï¼š\n\n' +
            '1. **APIå¯†é’¥é—®é¢˜**: DeepSeekæˆ–Tushare APIå¯†é’¥å¯èƒ½è¿‡æœŸ\n' +
            '2. **ç½‘ç»œé—®é¢˜**: APIæœåŠ¡å¯èƒ½æš‚æ—¶ä¸å¯ç”¨\n' +
            '3. **ä»£ç é”™è¯¯**: å¯èƒ½å­˜åœ¨ä»£ç bug\n' +
            '4. **é…é¢é™åˆ¶**: APIè°ƒç”¨å¯èƒ½è¶…å‡ºé™åˆ¶\n\n' +
            '### ğŸ“‹ æ’æŸ¥æ­¥éª¤\n\n' +
            '1. æŸ¥çœ‹ [Actionsæ—¥å¿—](https://github.com/' + repo + '/actions/runs/' + runId + ')\n' +
            '2. æ£€æŸ¥Secretsä¸­çš„APIå¯†é’¥æ˜¯å¦æ­£ç¡®\n' +
            '3. ç¡®è®¤APIæœåŠ¡çŠ¶æ€æ˜¯å¦æ­£å¸¸\n' +
            '4. å¦‚é—®é¢˜æŒç»­ï¼Œè¯·æ‰‹åŠ¨è¿è¡Œæµ‹è¯•\n\n' +
            '---\n\n' +
            '> ğŸ”§ **å»ºè®®**: å¯ä»¥æ‰‹åŠ¨è§¦å‘å·¥ä½œæµè¿›è¡Œæµ‹è¯•ï¼Œæˆ–ç­‰å¾…ä¸‹æ¬¡è‡ªåŠ¨è¿è¡Œã€‚';

          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: issueTitle,
            body: issueBody,
            labels: ['âŒ é”™è¯¯', 'ğŸ¤– è‡ªåŠ¨ç”Ÿæˆ', 'ğŸš¨ éœ€è¦å…³æ³¨']
          });
          
          console.log('âœ… å¤±è´¥é€šçŸ¥Issueåˆ›å»ºå®Œæˆ');
