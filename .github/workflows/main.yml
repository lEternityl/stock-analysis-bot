name: 📊 每日股票分析

on:
  schedule:
    - cron: '30 23 * * 0-4'  # UTC 23:30 = 北京时间 7:30 (周一到周五)
    - cron: '0 4 * * 1-5'    # UTC 4:00 = 北京时间 12:00 (周一到周五)
  
  workflow_dispatch:
    inputs:
      test_mode:
        description: '测试模式（只分析一只股票）'
        required: false
        default: false
        type: boolean
      analysis_type:
        description: '分析类型'
        required: false
        default: 'auto'
        type: choice
        options:
        - auto        # 自动判断
        - pre_market  # 开盘前分析
        - midday      # 中午分析
        - post_market # 收盘后分析

jobs:
  stock-analysis:
    runs-on: ubuntu-latest
    environment: env
    permissions:
      contents: write
      issues: write
      pull-requests: write
    
    steps:
    - name: 📥 检出代码
      uses: actions/checkout@v4
      
    - name: 🐍 设置Python环境
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: 📦 安装依赖
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: 📊 执行股票分析
      id: analysis
      env:
        DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        TUSHARE_TOKEN: ${{ secrets.TUSHARE_TOKEN }}
        ANALYSIS_TYPE: ${{ github.event.inputs.analysis_type || 'auto' }}
      run: |
        # 判断分析类型
        CURRENT_HOUR=$(date -u +%H)
        if [ "${{ github.event.inputs.analysis_type }}" = "pre_market" ]; then
          ANALYSIS_MODE="pre_market"
          echo "🌅 开盘前分析模式"
        elif [ "${{ github.event.inputs.analysis_type }}" = "midday" ]; then
          ANALYSIS_MODE="midday"
          echo "🕐 中午分析模式"
        elif [ "${{ github.event.inputs.analysis_type }}" = "post_market" ]; then
          ANALYSIS_MODE="post_market"
          echo "🌆 收盘后分析模式"
        else
          # 自动判断：UTC 23:30 = 开盘前，UTC 4:00 = 中午分析
          if [ "$CURRENT_HOUR" = "23" ] || [ "$CURRENT_HOUR" = "00" ]; then
            ANALYSIS_MODE="pre_market"
            echo "🌅 自动识别：开盘前分析 (UTC $CURRENT_HOUR:xx)"
          elif [ "$CURRENT_HOUR" = "4" ]; then
            ANALYSIS_MODE="midday"
            echo "🕐 自动识别：中午分析 (UTC $CURRENT_HOUR:xx)"
          else
            ANALYSIS_MODE="standard"
            echo "📊 自动识别：标准分析 (UTC $CURRENT_HOUR:xx)"
          fi
        fi
        
        # 设置分析模式环境变量
        export ANALYSIS_MODE=$ANALYSIS_MODE
        
        if [ "${{ github.event.inputs.test_mode }}" = "true" ]; then
          echo "🧪 测试模式：分析单只股票"
          python main.py --stock 600519.SH
        else
          echo "📊 正式模式：分析股票池"
          python main.py --watchlist
        fi
        
    - name: 📦 上传报告文件
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: stock-analysis-reports-${{ github.run_number }}
        path: |
          reports/**/*.md
          reports/**/*.json
          reports/README.md
        retention-days: 30
        
    - name: 📊 提交报告到仓库
      id: git-push
      if: success()
      continue-on-error: true
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git config core.fileMode false
        
        # 清理缓存文件
        echo "🧹 清理缓存文件..."
        find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
        find . -name "*.pyc" -delete 2>/dev/null || true
        
        # 简单的Git操作
        echo "📁 添加报告文件..."
        git add reports/ .gitignore
        
        if git diff --staged --quiet; then
          echo "📝 没有新的报告文件需要提交"
        else
          echo "📊 提交分析报告..."
          git commit -m "📊 自动生成股票分析报告 - $(date +'%Y-%m-%d %H:%M:%S')"
          
          echo "📤 推送到远程..."
          # 简单推送，失败也不影响整体流程
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git || {
            echo "⚠️ 推送失败，但不影响分析结果"
            echo "📦 报告文件已在Artifacts中可下载"
          }
        fi
        
    - name: 📧 创建分析完成通知Issue
      if: steps.analysis.conclusion == 'success'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          const path = require('path');
          
          const today = new Date().toLocaleDateString('zh-CN');
          const runNumber = '${{ github.run_number }}';
          const runId = '${{ github.run_id }}';
          const repo = '${{ github.repository }}';
          
          // 查找并读取最新的汇总报告
          let summaryContent = '';
          let tableContent = '';
          let statsContent = '';
          let analysisType = '标准分析';
          
          try {
            const reportsDir = 'reports';
            const files = fs.readdirSync(reportsDir);
            const summaryFiles = files.filter(f => f.startsWith('summary_') && f.endsWith('.md'));
            
            if (summaryFiles.length > 0) {
              const latestSummary = summaryFiles.sort().pop();
              summaryContent = fs.readFileSync(path.join(reportsDir, latestSummary), 'utf8');
              
              const lines = summaryContent.split('\n');
              let inTable = false;
              let inStats = false;
              
              // 提取分析类型
              for (const line of lines) {
                if (line.includes('分析类型**:')) {
                  const match = line.match(/\*\*分析类型\*\*:\s*(.+)/);
                  if (match) analysisType = match[1].trim();
                }
              }
              
              // 提取表格和统计内容
              for (const line of lines) {
                // 查找"📋 分析结果概览"部分的表格
                if (line.includes('## 📋 分析结果概览')) {
                  inTable = true;
                  continue;
                } else if (inTable && line.includes('| 股票代码 |')) {
                  tableContent += line + '\n';
                } else if (inTable && line.startsWith('|') && !line.includes('---')) {
                  tableContent += line + '\n';
                } else if (inTable && line.startsWith('---') && tableContent) {
                  // 添加表格分隔线
                  tableContent += line + '\n';
                } else if (inTable && !line.startsWith('|') && !line.startsWith('---') && line.trim() !== '') {
                  inTable = false;
                }
                
                // 查找"🎯 投资建议统计"部分
                if (line.includes('## 🎯 投资建议统计')) {
                  inStats = true;
                  continue;
                } else if (inStats && (line.startsWith('- 🟢') || line.startsWith('- 🟡') || line.startsWith('- 🔴'))) {
                  statsContent += line + '\n';
                } else if (inStats && line.startsWith('---')) {
                  inStats = false;
                }
              }
            }
          } catch (error) {
            console.log('读取汇总报告失败:', error);
            tableContent = '| 股票代码 | 状态 |\n|---------|------|\n| - | 报告处理中 |';
            statsContent = '- 📊 数据处理中...';
          }
          
          const issueTitle = '📊 每日股票分析报告 - ' + today;
          // 修复表格中的链接格式
          let fixedTableContent = tableContent;
          if (summaryFiles.length > 0) {
            const latestSummary = summaryFiles.sort().pop();
            // 添加summary链接信息
            fixedTableContent = '> 📊 **完整汇总报告**: [' + latestSummary + '](reports/' + latestSummary + ')\n\n' + tableContent;
            
            // 修复表格中的链接 - 将股票代码转换为完整路径
            const today_date = new Date().toISOString().split('T')[0]; // YYYY-MM-DD格式
            fixedTableContent = fixedTableContent.replace(/\| ([0-9]{6}\.[A-Z]{2}) \|/g, (match, stockCode) => {
              const cleanCode = stockCode.replace('.SH', '').replace('.SZ', '').replace('.HK', '');
              return '| [' + stockCode + '](reports/' + cleanCode + '/' + today_date + '/) |';
            });
          }
          
          const issueBody = '## 📊 今日股票分析完成！\n\n' +
            '**分析时间**: ' + today + ' (北京时间)\n' +
            '**分析类型**: ' + analysisType + '\n' +
            '**运行ID**: #' + runNumber + '\n\n' +
            '## 📋 分析结果概览\n\n' +
            fixedTableContent + '\n' +
            '## 🎯 投资建议统计\n\n' +
            statsContent + '\n' +
            '### 📎 详细报告\n\n' +
            '- 📦 [下载所有报告](https://github.com/' + repo + '/actions/runs/' + runId + ')\n' +
            '- 📋 [查看报告目录](https://github.com/' + repo + '/tree/main/reports) - 按股票和日期分类\n' +
            '- 📊 [报告索引](https://github.com/' + repo + '/blob/main/reports/README.md) - 完整目录导航\n\n' +
            '### 🤖 系统信息\n\n' +
            '- **AI模型**: DeepSeek ✅\n' +
            '- **数据源**: Tushare ✅\n' +
            '- **运行状态**: ✅ 成功\n' +
            '- **下次运行**: 工作日 7:30 / 12:00\n\n' +
            '---\n\n' +
            '> 💡 **提示**: 上方表格显示完整分析结果，点击链接查看详细报告。\n\n' +
            '> ⚠️ **风险提示**: 本报告仅供参考，不构成投资建议。投资有风险，决策需谨慎。';

          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: issueTitle,
            body: issueBody,
            labels: ['📊 分析报告', '🤖 自动生成']
          });
          
          console.log('✅ 成功通知Issue创建完成');
          
    - name: 📧 创建分析失败通知Issue
      if: steps.analysis.conclusion == 'failure'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const today = new Date().toLocaleDateString('zh-CN');
          const runNumber = '${{ github.run_number }}';
          const runId = '${{ github.run_id }}';
          const repo = '${{ github.repository }}';
          
          const issueTitle = '❌ 股票分析失败 - ' + today;
          const issueBody = '## ❌ 今日股票分析失败\n\n' +
            '**失败时间**: ' + today + '\n' +
            '**运行ID**: #' + runNumber + '\n\n' +
            '### 🔍 故障信息\n\n' +
            '请检查以下可能的原因：\n\n' +
            '1. **API密钥问题**: DeepSeek或Tushare API密钥可能过期\n' +
            '2. **网络问题**: API服务可能暂时不可用\n' +
            '3. **代码错误**: 可能存在代码bug\n' +
            '4. **配额限制**: API调用可能超出限制\n\n' +
            '### 📋 排查步骤\n\n' +
            '1. 查看 [Actions日志](https://github.com/' + repo + '/actions/runs/' + runId + ')\n' +
            '2. 检查Secrets中的API密钥是否正确\n' +
            '3. 确认API服务状态是否正常\n' +
            '4. 如问题持续，请手动运行测试\n\n' +
            '---\n\n' +
            '> 🔧 **建议**: 可以手动触发工作流进行测试，或等待下次自动运行。';

          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: issueTitle,
            body: issueBody,
            labels: ['❌ 错误', '🤖 自动生成', '🚨 需要关注']
          });
          
          console.log('✅ 失败通知Issue创建完成');
          
    - name: 📧 创建Git推送失败通知Issue
      if: steps.analysis.conclusion == 'success' && steps.git-push.conclusion == 'failure'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const today = new Date().toLocaleDateString('zh-CN');
          const runNumber = '${{ github.run_number }}';
          const runId = '${{ github.run_id }}';
          const repo = '${{ github.repository }}';
          
          const issueTitle = '⚠️ 分析成功但推送失败 - ' + today;
          const issueBody = '## ⚠️ 股票分析成功，但Git推送失败\n\n' +
            '**时间**: ' + today + '\n' +
            '**运行ID**: #' + runNumber + '\n\n' +
            '### ✅ 成功部分\n\n' +
            '- ✅ 股票分析完成\n' +
            '- ✅ 报告生成成功\n' +
            '- ✅ 文件上传到Artifacts\n\n' +
            '### ❌ 失败部分\n\n' +
            '- ❌ Git推送到仓库失败（可能是代码冲突）\n\n' +
            '### 📎 获取报告\n\n' +
            '- 📦 [下载分析报告](https://github.com/' + repo + '/actions/runs/' + runId + ')\n' +
            '- 📋 报告已生成但未推送到仓库\n\n' +
            '### 🔧 解决方案\n\n' +
            '1. 手动下载报告文件\n' +
            '2. 等待下次自动运行（已优化推送逻辑）\n' +
            '3. 检查是否有其他进程在修改仓库\n\n' +
            '---\n\n' +
            '> 💡 **说明**: 这不影响分析质量，报告仍可通过Artifacts下载。';

          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: issueTitle,
            body: issueBody,
            labels: ['⚠️ 部分失败', '🤖 自动生成', '📊 分析报告']
          });
          
          console.log('✅ Git推送失败通知Issue创建完成');