name: ğŸ“Š æ¯æ—¥è‚¡ç¥¨åˆ†æ

on:
  schedule:
    - cron: '30 23 * * 0-4'  # UTC 23:30 = åŒ—äº¬æ—¶é—´ 7:30 (å‘¨ä¸€åˆ°å‘¨äº”)
    - cron: '0 4 * * 1-5'    # UTC 4:00 = åŒ—äº¬æ—¶é—´ 12:00 (å‘¨ä¸€åˆ°å‘¨äº”)
  
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'æµ‹è¯•æ¨¡å¼ï¼ˆåªåˆ†æä¸€åªè‚¡ç¥¨ï¼‰'
        required: false
        default: false
        type: boolean
      analysis_type:
        description: 'åˆ†æç±»å‹'
        required: false
        default: 'auto'
        type: choice
        options:
        - auto        # è‡ªåŠ¨åˆ¤æ–­
        - pre_market  # å¼€ç›˜å‰åˆ†æ
        - midday      # ä¸­åˆåˆ†æ
        - post_market # æ”¶ç›˜ååˆ†æ

jobs:
  stock-analysis:
    runs-on: ubuntu-latest
    environment: env
    permissions:
      contents: write
      issues: write
      pull-requests: write
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ğŸ“Š æ‰§è¡Œè‚¡ç¥¨åˆ†æ
      id: analysis
      env:
        DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        TUSHARE_TOKEN: ${{ secrets.TUSHARE_TOKEN }}
        ANALYSIS_TYPE: ${{ github.event.inputs.analysis_type || 'auto' }}
      run: |
        # åˆ¤æ–­åˆ†æç±»å‹
        CURRENT_HOUR=$(date -u +%H)
        if [ "${{ github.event.inputs.analysis_type }}" = "pre_market" ]; then
          ANALYSIS_MODE="pre_market"
          echo "ğŸŒ… å¼€ç›˜å‰åˆ†ææ¨¡å¼"
        elif [ "${{ github.event.inputs.analysis_type }}" = "midday" ]; then
          ANALYSIS_MODE="midday"
          echo "ğŸ• ä¸­åˆåˆ†ææ¨¡å¼"
        elif [ "${{ github.event.inputs.analysis_type }}" = "post_market" ]; then
          ANALYSIS_MODE="post_market"
          echo "ğŸŒ† æ”¶ç›˜ååˆ†ææ¨¡å¼"
        else
          # è‡ªåŠ¨åˆ¤æ–­ï¼šUTC 23:30 = å¼€ç›˜å‰ï¼ŒUTC 4:00 = ä¸­åˆåˆ†æ
          if [ "$CURRENT_HOUR" = "23" ] || [ "$CURRENT_HOUR" = "00" ]; then
            ANALYSIS_MODE="pre_market"
            echo "ğŸŒ… è‡ªåŠ¨è¯†åˆ«ï¼šå¼€ç›˜å‰åˆ†æ (UTC $CURRENT_HOUR:xx)"
          elif [ "$CURRENT_HOUR" = "4" ]; then
            ANALYSIS_MODE="midday"
            echo "ğŸ• è‡ªåŠ¨è¯†åˆ«ï¼šä¸­åˆåˆ†æ (UTC $CURRENT_HOUR:xx)"
          else
            ANALYSIS_MODE="standard"
            echo "ğŸ“Š è‡ªåŠ¨è¯†åˆ«ï¼šæ ‡å‡†åˆ†æ (UTC $CURRENT_HOUR:xx)"
          fi
        fi
        
        # è®¾ç½®åˆ†ææ¨¡å¼ç¯å¢ƒå˜é‡
        export ANALYSIS_MODE=$ANALYSIS_MODE
        
        if [ "${{ github.event.inputs.test_mode }}" = "true" ]; then
          echo "ğŸ§ª æµ‹è¯•æ¨¡å¼ï¼šåˆ†æå•åªè‚¡ç¥¨"
          python main.py --stock 600519.SH
        else
          echo "ğŸ“Š æ­£å¼æ¨¡å¼ï¼šåˆ†æè‚¡ç¥¨æ± "
          python main.py --watchlist
        fi
        
    - name: ğŸ“¦ ä¸Šä¼ æŠ¥å‘Šæ–‡ä»¶
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: stock-analysis-reports-${{ github.run_number }}
        path: |
          reports/**/*.md
          reports/**/*.json
          reports/README.md
        retention-days: 30
        
    - name: ğŸ“Š æäº¤æŠ¥å‘Šåˆ°ä»“åº“
      id: git-push
      if: success()
      continue-on-error: true
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git config core.fileMode false
        
        # æ¸…ç†ç¼“å­˜æ–‡ä»¶
        echo "ğŸ§¹ æ¸…ç†ç¼“å­˜æ–‡ä»¶..."
        find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
        find . -name "*.pyc" -delete 2>/dev/null || true
        
        # ç®€å•çš„Gitæ“ä½œ
        echo "ğŸ“ æ·»åŠ æŠ¥å‘Šæ–‡ä»¶..."
        git add reports/ .gitignore
        
        if git diff --staged --quiet; then
          echo "ğŸ“ æ²¡æœ‰æ–°çš„æŠ¥å‘Šæ–‡ä»¶éœ€è¦æäº¤"
        else
          echo "ğŸ“Š æäº¤åˆ†ææŠ¥å‘Š..."
          git commit -m "ğŸ“Š è‡ªåŠ¨ç”Ÿæˆè‚¡ç¥¨åˆ†ææŠ¥å‘Š - $(date +'%Y-%m-%d %H:%M:%S')"
          
          echo "ğŸ“¤ æ¨é€åˆ°è¿œç¨‹..."
          # ç®€å•æ¨é€ï¼Œå¤±è´¥ä¹Ÿä¸å½±å“æ•´ä½“æµç¨‹
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git || {
            echo "âš ï¸ æ¨é€å¤±è´¥ï¼Œä½†ä¸å½±å“åˆ†æç»“æœ"
            echo "ğŸ“¦ æŠ¥å‘Šæ–‡ä»¶å·²åœ¨Artifactsä¸­å¯ä¸‹è½½"
          }
        fi
        
    - name: ğŸ“§ åˆ›å»ºåˆ†æå®Œæˆé€šçŸ¥Issue
      if: steps.analysis.conclusion == 'success'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          const path = require('path');
          
          const today = new Date().toLocaleDateString('zh-CN');
          const runNumber = '${{ github.run_number }}';
          const runId = '${{ github.run_id }}';
          const repo = '${{ github.repository }}';
          
          // æŸ¥æ‰¾å¹¶è¯»å–æœ€æ–°çš„æ±‡æ€»æŠ¥å‘Š
          let summaryContent = '';
          let tableContent = '';
          let statsContent = '';
          let analysisType = 'æ ‡å‡†åˆ†æ';
          
          try {
            const reportsDir = 'reports';
            const files = fs.readdirSync(reportsDir);
            const summaryFiles = files.filter(f => f.startsWith('summary_') && f.endsWith('.md'));
            
            if (summaryFiles.length > 0) {
              const latestSummary = summaryFiles.sort().pop();
              summaryContent = fs.readFileSync(path.join(reportsDir, latestSummary), 'utf8');
              
              const lines = summaryContent.split('\n');
              let inTable = false;
              let inStats = false;
              
              // æå–åˆ†æç±»å‹
              for (const line of lines) {
                if (line.includes('åˆ†æç±»å‹**:')) {
                  const match = line.match(/\*\*åˆ†æç±»å‹\*\*:\s*(.+)/);
                  if (match) analysisType = match[1].trim();
                }
              }
              
              // æå–è¡¨æ ¼å’Œç»Ÿè®¡å†…å®¹
              for (const line of lines) {
                // æŸ¥æ‰¾"ğŸ“‹ åˆ†æç»“æœæ¦‚è§ˆ"éƒ¨åˆ†çš„è¡¨æ ¼
                if (line.includes('## ğŸ“‹ åˆ†æç»“æœæ¦‚è§ˆ')) {
                  inTable = true;
                  continue;
                } else if (inTable && line.includes('| è‚¡ç¥¨ä»£ç  |')) {
                  tableContent += line + '\n';
                } else if (inTable && line.startsWith('|') && !line.includes('---')) {
                  tableContent += line + '\n';
                } else if (inTable && line.startsWith('---') && tableContent) {
                  // æ·»åŠ è¡¨æ ¼åˆ†éš”çº¿
                  tableContent += line + '\n';
                } else if (inTable && !line.startsWith('|') && !line.startsWith('---') && line.trim() !== '') {
                  inTable = false;
                }
                
                // æŸ¥æ‰¾"ğŸ¯ æŠ•èµ„å»ºè®®ç»Ÿè®¡"éƒ¨åˆ†
                if (line.includes('## ğŸ¯ æŠ•èµ„å»ºè®®ç»Ÿè®¡')) {
                  inStats = true;
                  continue;
                } else if (inStats && (line.startsWith('- ğŸŸ¢') || line.startsWith('- ğŸŸ¡') || line.startsWith('- ğŸ”´'))) {
                  statsContent += line + '\n';
                } else if (inStats && line.startsWith('---')) {
                  inStats = false;
                }
              }
            }
          } catch (error) {
            console.log('è¯»å–æ±‡æ€»æŠ¥å‘Šå¤±è´¥:', error);
            tableContent = '| è‚¡ç¥¨ä»£ç  | çŠ¶æ€ |\n|---------|------|\n| - | æŠ¥å‘Šå¤„ç†ä¸­ |';
            statsContent = '- ğŸ“Š æ•°æ®å¤„ç†ä¸­...';
          }
          
          const issueTitle = 'ğŸ“Š æ¯æ—¥è‚¡ç¥¨åˆ†ææŠ¥å‘Š - ' + today;
          // ä¿®å¤è¡¨æ ¼ä¸­çš„é“¾æ¥æ ¼å¼
          let fixedTableContent = tableContent;
          if (summaryFiles.length > 0) {
            const latestSummary = summaryFiles.sort().pop();
            // æ·»åŠ summaryé“¾æ¥ä¿¡æ¯
            fixedTableContent = '> ğŸ“Š **å®Œæ•´æ±‡æ€»æŠ¥å‘Š**: [' + latestSummary + '](reports/' + latestSummary + ')\n\n' + tableContent;
            
            // ä¿®å¤è¡¨æ ¼ä¸­çš„é“¾æ¥ - å°†è‚¡ç¥¨ä»£ç è½¬æ¢ä¸ºå®Œæ•´è·¯å¾„
            const today_date = new Date().toISOString().split('T')[0]; // YYYY-MM-DDæ ¼å¼
            fixedTableContent = fixedTableContent.replace(/\| ([0-9]{6}\.[A-Z]{2}) \|/g, (match, stockCode) => {
              const cleanCode = stockCode.replace('.SH', '').replace('.SZ', '').replace('.HK', '');
              return '| [' + stockCode + '](reports/' + cleanCode + '/' + today_date + '/) |';
            });
          }
          
          const issueBody = '## ğŸ“Š ä»Šæ—¥è‚¡ç¥¨åˆ†æå®Œæˆï¼\n\n' +
            '**åˆ†ææ—¶é—´**: ' + today + ' (åŒ—äº¬æ—¶é—´)\n' +
            '**åˆ†æç±»å‹**: ' + analysisType + '\n' +
            '**è¿è¡ŒID**: #' + runNumber + '\n\n' +
            '## ğŸ“‹ åˆ†æç»“æœæ¦‚è§ˆ\n\n' +
            fixedTableContent + '\n' +
            '## ğŸ¯ æŠ•èµ„å»ºè®®ç»Ÿè®¡\n\n' +
            statsContent + '\n' +
            '### ğŸ“ è¯¦ç»†æŠ¥å‘Š\n\n' +
            '- ğŸ“¦ [ä¸‹è½½æ‰€æœ‰æŠ¥å‘Š](https://github.com/' + repo + '/actions/runs/' + runId + ')\n' +
            '- ğŸ“‹ [æŸ¥çœ‹æŠ¥å‘Šç›®å½•](https://github.com/' + repo + '/tree/main/reports) - æŒ‰è‚¡ç¥¨å’Œæ—¥æœŸåˆ†ç±»\n' +
            '- ğŸ“Š [æŠ¥å‘Šç´¢å¼•](https://github.com/' + repo + '/blob/main/reports/README.md) - å®Œæ•´ç›®å½•å¯¼èˆª\n\n' +
            '### ğŸ¤– ç³»ç»Ÿä¿¡æ¯\n\n' +
            '- **AIæ¨¡å‹**: DeepSeek âœ…\n' +
            '- **æ•°æ®æº**: Tushare âœ…\n' +
            '- **è¿è¡ŒçŠ¶æ€**: âœ… æˆåŠŸ\n' +
            '- **ä¸‹æ¬¡è¿è¡Œ**: å·¥ä½œæ—¥ 7:30 / 12:00\n\n' +
            '---\n\n' +
            '> ğŸ’¡ **æç¤º**: ä¸Šæ–¹è¡¨æ ¼æ˜¾ç¤ºå®Œæ•´åˆ†æç»“æœï¼Œç‚¹å‡»é“¾æ¥æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Šã€‚\n\n' +
            '> âš ï¸ **é£é™©æç¤º**: æœ¬æŠ¥å‘Šä»…ä¾›å‚è€ƒï¼Œä¸æ„æˆæŠ•èµ„å»ºè®®ã€‚æŠ•èµ„æœ‰é£é™©ï¼Œå†³ç­–éœ€è°¨æ…ã€‚';

          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: issueTitle,
            body: issueBody,
            labels: ['ğŸ“Š åˆ†ææŠ¥å‘Š', 'ğŸ¤– è‡ªåŠ¨ç”Ÿæˆ']
          });
          
          console.log('âœ… æˆåŠŸé€šçŸ¥Issueåˆ›å»ºå®Œæˆ');
          
    - name: ğŸ“§ åˆ›å»ºåˆ†æå¤±è´¥é€šçŸ¥Issue
      if: steps.analysis.conclusion == 'failure'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const today = new Date().toLocaleDateString('zh-CN');
          const runNumber = '${{ github.run_number }}';
          const runId = '${{ github.run_id }}';
          const repo = '${{ github.repository }}';
          
          const issueTitle = 'âŒ è‚¡ç¥¨åˆ†æå¤±è´¥ - ' + today;
          const issueBody = '## âŒ ä»Šæ—¥è‚¡ç¥¨åˆ†æå¤±è´¥\n\n' +
            '**å¤±è´¥æ—¶é—´**: ' + today + '\n' +
            '**è¿è¡ŒID**: #' + runNumber + '\n\n' +
            '### ğŸ” æ•…éšœä¿¡æ¯\n\n' +
            'è¯·æ£€æŸ¥ä»¥ä¸‹å¯èƒ½çš„åŸå› ï¼š\n\n' +
            '1. **APIå¯†é’¥é—®é¢˜**: DeepSeekæˆ–Tushare APIå¯†é’¥å¯èƒ½è¿‡æœŸ\n' +
            '2. **ç½‘ç»œé—®é¢˜**: APIæœåŠ¡å¯èƒ½æš‚æ—¶ä¸å¯ç”¨\n' +
            '3. **ä»£ç é”™è¯¯**: å¯èƒ½å­˜åœ¨ä»£ç bug\n' +
            '4. **é…é¢é™åˆ¶**: APIè°ƒç”¨å¯èƒ½è¶…å‡ºé™åˆ¶\n\n' +
            '### ğŸ“‹ æ’æŸ¥æ­¥éª¤\n\n' +
            '1. æŸ¥çœ‹ [Actionsæ—¥å¿—](https://github.com/' + repo + '/actions/runs/' + runId + ')\n' +
            '2. æ£€æŸ¥Secretsä¸­çš„APIå¯†é’¥æ˜¯å¦æ­£ç¡®\n' +
            '3. ç¡®è®¤APIæœåŠ¡çŠ¶æ€æ˜¯å¦æ­£å¸¸\n' +
            '4. å¦‚é—®é¢˜æŒç»­ï¼Œè¯·æ‰‹åŠ¨è¿è¡Œæµ‹è¯•\n\n' +
            '---\n\n' +
            '> ğŸ”§ **å»ºè®®**: å¯ä»¥æ‰‹åŠ¨è§¦å‘å·¥ä½œæµè¿›è¡Œæµ‹è¯•ï¼Œæˆ–ç­‰å¾…ä¸‹æ¬¡è‡ªåŠ¨è¿è¡Œã€‚';

          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: issueTitle,
            body: issueBody,
            labels: ['âŒ é”™è¯¯', 'ğŸ¤– è‡ªåŠ¨ç”Ÿæˆ', 'ğŸš¨ éœ€è¦å…³æ³¨']
          });
          
          console.log('âœ… å¤±è´¥é€šçŸ¥Issueåˆ›å»ºå®Œæˆ');
          
    - name: ğŸ“§ åˆ›å»ºGitæ¨é€å¤±è´¥é€šçŸ¥Issue
      if: steps.analysis.conclusion == 'success' && steps.git-push.conclusion == 'failure'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const today = new Date().toLocaleDateString('zh-CN');
          const runNumber = '${{ github.run_number }}';
          const runId = '${{ github.run_id }}';
          const repo = '${{ github.repository }}';
          
          const issueTitle = 'âš ï¸ åˆ†ææˆåŠŸä½†æ¨é€å¤±è´¥ - ' + today;
          const issueBody = '## âš ï¸ è‚¡ç¥¨åˆ†ææˆåŠŸï¼Œä½†Gitæ¨é€å¤±è´¥\n\n' +
            '**æ—¶é—´**: ' + today + '\n' +
            '**è¿è¡ŒID**: #' + runNumber + '\n\n' +
            '### âœ… æˆåŠŸéƒ¨åˆ†\n\n' +
            '- âœ… è‚¡ç¥¨åˆ†æå®Œæˆ\n' +
            '- âœ… æŠ¥å‘Šç”ŸæˆæˆåŠŸ\n' +
            '- âœ… æ–‡ä»¶ä¸Šä¼ åˆ°Artifacts\n\n' +
            '### âŒ å¤±è´¥éƒ¨åˆ†\n\n' +
            '- âŒ Gitæ¨é€åˆ°ä»“åº“å¤±è´¥ï¼ˆå¯èƒ½æ˜¯ä»£ç å†²çªï¼‰\n\n' +
            '### ğŸ“ è·å–æŠ¥å‘Š\n\n' +
            '- ğŸ“¦ [ä¸‹è½½åˆ†ææŠ¥å‘Š](https://github.com/' + repo + '/actions/runs/' + runId + ')\n' +
            '- ğŸ“‹ æŠ¥å‘Šå·²ç”Ÿæˆä½†æœªæ¨é€åˆ°ä»“åº“\n\n' +
            '### ğŸ”§ è§£å†³æ–¹æ¡ˆ\n\n' +
            '1. æ‰‹åŠ¨ä¸‹è½½æŠ¥å‘Šæ–‡ä»¶\n' +
            '2. ç­‰å¾…ä¸‹æ¬¡è‡ªåŠ¨è¿è¡Œï¼ˆå·²ä¼˜åŒ–æ¨é€é€»è¾‘ï¼‰\n' +
            '3. æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–è¿›ç¨‹åœ¨ä¿®æ”¹ä»“åº“\n\n' +
            '---\n\n' +
            '> ğŸ’¡ **è¯´æ˜**: è¿™ä¸å½±å“åˆ†æè´¨é‡ï¼ŒæŠ¥å‘Šä»å¯é€šè¿‡Artifactsä¸‹è½½ã€‚';

          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: issueTitle,
            body: issueBody,
            labels: ['âš ï¸ éƒ¨åˆ†å¤±è´¥', 'ğŸ¤– è‡ªåŠ¨ç”Ÿæˆ', 'ğŸ“Š åˆ†ææŠ¥å‘Š']
          });
          
          console.log('âœ… Gitæ¨é€å¤±è´¥é€šçŸ¥Issueåˆ›å»ºå®Œæˆ');