name: ğŸ“Š æ¯æ—¥è‚¡ç¥¨åˆ†æ

on:
  schedule:
    - cron: '30 23 * * 0-4'  # UTC 23:30 = åŒ—äº¬æ—¶é—´ 7:30 (å‘¨ä¸€åˆ°å‘¨äº”)
    - cron: '30 12 * * 0-4'  # UTC 12:30 = åŒ—äº¬æ—¶é—´ 20:30 (å‘¨ä¸€åˆ°å‘¨äº”)
  
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'æµ‹è¯•æ¨¡å¼ï¼ˆåªåˆ†æä¸€åªè‚¡ç¥¨ï¼‰'
        required: false
        default: 'false'
        type: boolean
      analysis_type:
        description: 'åˆ†æç±»å‹'
        required: false
        default: 'auto'
        type: choice
        options:
        - auto        # è‡ªåŠ¨åˆ¤æ–­
        - pre_market  # å¼€ç›˜å‰åˆ†æ
        - post_market # æ”¶ç›˜ååˆ†æ

jobs:
  stock-analysis:
    runs-on: ubuntu-latest
    environment: env
    permissions:
      contents: write
      issues: write
      pull-requests: write
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ğŸ“Š æ‰§è¡Œè‚¡ç¥¨åˆ†æ
      id: analysis
      env:
        DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        TUSHARE_TOKEN: ${{ secrets.TUSHARE_TOKEN }}
        ANALYSIS_TYPE: ${{ github.event.inputs.analysis_type || 'auto' }}
      run: |
        # åˆ¤æ–­åˆ†æç±»å‹
        CURRENT_HOUR=$(date -u +%H)
        if [ "${{ github.event.inputs.analysis_type }}" = "pre_market" ]; then
          ANALYSIS_MODE="pre_market"
          echo "ğŸŒ… å¼€ç›˜å‰åˆ†ææ¨¡å¼"
        elif [ "${{ github.event.inputs.analysis_type }}" = "post_market" ]; then
          ANALYSIS_MODE="post_market"
          echo "ğŸŒ† æ”¶ç›˜ååˆ†ææ¨¡å¼"
        else
          # è‡ªåŠ¨åˆ¤æ–­ï¼šUTC 23:30 = å¼€ç›˜å‰ï¼ŒUTC 12:30 = æ”¶ç›˜å
          if [ "$CURRENT_HOUR" = "23" ] || [ "$CURRENT_HOUR" = "00" ]; then
            ANALYSIS_MODE="pre_market"
            echo "ğŸŒ… è‡ªåŠ¨è¯†åˆ«ï¼šå¼€ç›˜å‰åˆ†æ (UTC $CURRENT_HOUR:xx)"
          else
            ANALYSIS_MODE="post_market"
            echo "ğŸŒ† è‡ªåŠ¨è¯†åˆ«ï¼šæ”¶ç›˜ååˆ†æ (UTC $CURRENT_HOUR:xx)"
          fi
        fi
        
        # è®¾ç½®åˆ†ææ¨¡å¼ç¯å¢ƒå˜é‡
        export ANALYSIS_MODE=$ANALYSIS_MODE
        
        if [ "${{ github.event.inputs.test_mode }}" = "true" ]; then
          echo "ğŸ§ª æµ‹è¯•æ¨¡å¼ï¼šåˆ†æå•åªè‚¡ç¥¨"
          python main.py --stock 600519.SH
        else
          echo "ğŸ“Š æ­£å¼æ¨¡å¼ï¼šåˆ†æè‚¡ç¥¨æ± "
          python main.py --watchlist
        fi
        
    - name: ğŸ“¦ ä¸Šä¼ æŠ¥å‘Šæ–‡ä»¶
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: stock-analysis-reports-${{ github.run_number }}
        path: |
          reports/**/*.md
          reports/**/*.json
          reports/README.md
        retention-days: 30
        
    - name: ğŸ“Š æäº¤æŠ¥å‘Šåˆ°ä»“åº“
      id: git-push
      if: success()
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ¸…ç†Pythonç¼“å­˜æ–‡ä»¶
        echo "ğŸ§¹ æ¸…ç†Pythonç¼“å­˜æ–‡ä»¶..."
        find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
        find . -name "*.pyc" -delete 2>/dev/null || true
        
        # é…ç½®Gitå¿½ç•¥æ–‡ä»¶æƒé™å˜åŒ–
        git config core.fileMode false
        
        # å¼ºåˆ¶åŒæ­¥è¿œç¨‹æ›´æ–°
        echo "ğŸ“¥ å¼ºåˆ¶åŒæ­¥è¿œç¨‹æ›´æ–°..."
        git fetch origin
        git reset --hard origin/main
        
        # é‡æ–°è¿è¡ŒPythonç”ŸæˆæŠ¥å‘Šï¼ˆå› ä¸ºresetåæ–‡ä»¶ä¸¢å¤±ï¼‰
        echo "ğŸ”„ é‡æ–°ç”ŸæˆæŠ¥å‘Šæ–‡ä»¶..."
        if [ "${{ github.event.inputs.test_mode }}" = "true" ]; then
          python main.py --stock 600519.SH
        else
          python main.py --watchlist
        fi
        
        # æ·»åŠ æ–°ç”Ÿæˆçš„æ–‡ä»¶
        echo "ğŸ“ æ·»åŠ æŠ¥å‘Šæ–‡ä»¶..."
        git add reports/ .gitignore
        
        if git diff --staged --quiet; then
          echo "ğŸ“ æ²¡æœ‰æ–°çš„æŠ¥å‘Šæ–‡ä»¶éœ€è¦æäº¤"
        else
          echo "ğŸ“Š æäº¤æ–°çš„åˆ†ææŠ¥å‘Š..."
          git commit -m "ğŸ“Š è‡ªåŠ¨ç”Ÿæˆè‚¡ç¥¨åˆ†ææŠ¥å‘Š - $(date +'%Y-%m-%d %H:%M:%S')"
          
          # æ¨é€åˆ°è¿œç¨‹
          echo "ğŸ“¤ æ¨é€åˆ°è¿œç¨‹ä»“åº“..."
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          echo "âœ… æŠ¥å‘Šæ¨é€æˆåŠŸ"
        fi
        
    - name: ğŸ“§ åˆ›å»ºåˆ†æå®Œæˆé€šçŸ¥Issue
      if: steps.analysis.conclusion == 'success'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const today = new Date().toLocaleDateString('zh-CN');
          const runNumber = '${{ github.run_number }}';
          const runId = '${{ github.run_id }}';
          const repo = '${{ github.repository }}';
          
          const issueTitle = 'ğŸ“Š æ¯æ—¥è‚¡ç¥¨åˆ†ææŠ¥å‘Š - ' + today;
          const issueBody = '## ğŸ“Š ä»Šæ—¥è‚¡ç¥¨åˆ†æå®Œæˆï¼\n\n' +
            '**åˆ†ææ—¶é—´**: ' + today + '\n' +
            '**è¿è¡ŒID**: #' + runNumber + '\n\n' +
            '### ğŸ“ è¯¦ç»†æŠ¥å‘Š\n\n' +
            '- ğŸ“¦ [ä¸‹è½½æ‰€æœ‰æŠ¥å‘Š](https://github.com/' + repo + '/actions/runs/' + runId + ')\n' +
            '- ğŸ“‹ [æŸ¥çœ‹æŠ¥å‘Šç›®å½•](https://github.com/' + repo + '/tree/main/reports) - æŒ‰è‚¡ç¥¨å’Œæ—¥æœŸåˆ†ç±»\n' +
            '- ğŸ“Š [æŠ¥å‘Šç´¢å¼•](https://github.com/' + repo + '/blob/main/reports/README.md) - å®Œæ•´ç›®å½•å¯¼èˆª\n\n' +
            '### ğŸ¤– ç³»ç»Ÿä¿¡æ¯\n\n' +
            '- **AIæ¨¡å‹**: DeepSeek\n' +
            '- **æ•°æ®æº**: Tushare\n' +
            '- **è¿è¡ŒçŠ¶æ€**: âœ… æˆåŠŸ\n' +
            '- **ä¸‹æ¬¡è¿è¡Œ**: æ˜å¤© 08:00\n\n' +
            '---\n\n' +
            '> ğŸ’¡ **æç¤º**: åœ¨Actionsé¡µé¢ä¸‹è½½å®Œæ•´æŠ¥å‘Šæ–‡ä»¶ã€‚\n\n' +
            '> âš ï¸ **é£é™©æç¤º**: æœ¬æŠ¥å‘Šä»…ä¾›å‚è€ƒï¼Œä¸æ„æˆæŠ•èµ„å»ºè®®ã€‚æŠ•èµ„æœ‰é£é™©ï¼Œå†³ç­–éœ€è°¨æ…ã€‚';

          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: issueTitle,
            body: issueBody,
            labels: ['ğŸ“Š åˆ†ææŠ¥å‘Š', 'ğŸ¤– è‡ªåŠ¨ç”Ÿæˆ']
          });
          
          console.log('âœ… æˆåŠŸé€šçŸ¥Issueåˆ›å»ºå®Œæˆ');
          
    - name: ğŸ“§ åˆ›å»ºåˆ†æå¤±è´¥é€šçŸ¥Issue
      if: steps.analysis.conclusion == 'failure'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const today = new Date().toLocaleDateString('zh-CN');
          const runNumber = '${{ github.run_number }}';
          const runId = '${{ github.run_id }}';
          const repo = '${{ github.repository }}';
          
          const issueTitle = 'âŒ è‚¡ç¥¨åˆ†æå¤±è´¥ - ' + today;
          const issueBody = '## âŒ ä»Šæ—¥è‚¡ç¥¨åˆ†æå¤±è´¥\n\n' +
            '**å¤±è´¥æ—¶é—´**: ' + today + '\n' +
            '**è¿è¡ŒID**: #' + runNumber + '\n\n' +
            '### ğŸ” æ•…éšœä¿¡æ¯\n\n' +
            'è¯·æ£€æŸ¥ä»¥ä¸‹å¯èƒ½çš„åŸå› ï¼š\n\n' +
            '1. **APIå¯†é’¥é—®é¢˜**: DeepSeekæˆ–Tushare APIå¯†é’¥å¯èƒ½è¿‡æœŸ\n' +
            '2. **ç½‘ç»œé—®é¢˜**: APIæœåŠ¡å¯èƒ½æš‚æ—¶ä¸å¯ç”¨\n' +
            '3. **ä»£ç é”™è¯¯**: å¯èƒ½å­˜åœ¨ä»£ç bug\n' +
            '4. **é…é¢é™åˆ¶**: APIè°ƒç”¨å¯èƒ½è¶…å‡ºé™åˆ¶\n\n' +
            '### ğŸ“‹ æ’æŸ¥æ­¥éª¤\n\n' +
            '1. æŸ¥çœ‹ [Actionsæ—¥å¿—](https://github.com/' + repo + '/actions/runs/' + runId + ')\n' +
            '2. æ£€æŸ¥Secretsä¸­çš„APIå¯†é’¥æ˜¯å¦æ­£ç¡®\n' +
            '3. ç¡®è®¤APIæœåŠ¡çŠ¶æ€æ˜¯å¦æ­£å¸¸\n' +
            '4. å¦‚é—®é¢˜æŒç»­ï¼Œè¯·æ‰‹åŠ¨è¿è¡Œæµ‹è¯•\n\n' +
            '---\n\n' +
            '> ğŸ”§ **å»ºè®®**: å¯ä»¥æ‰‹åŠ¨è§¦å‘å·¥ä½œæµè¿›è¡Œæµ‹è¯•ï¼Œæˆ–ç­‰å¾…ä¸‹æ¬¡è‡ªåŠ¨è¿è¡Œã€‚';

          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: issueTitle,
            body: issueBody,
            labels: ['âŒ é”™è¯¯', 'ğŸ¤– è‡ªåŠ¨ç”Ÿæˆ', 'ğŸš¨ éœ€è¦å…³æ³¨']
          });
          
          console.log('âœ… å¤±è´¥é€šçŸ¥Issueåˆ›å»ºå®Œæˆ');
          
    - name: ğŸ“§ åˆ›å»ºGitæ¨é€å¤±è´¥é€šçŸ¥Issue
      if: steps.analysis.conclusion == 'success' && steps.git-push.conclusion == 'failure'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const today = new Date().toLocaleDateString('zh-CN');
          const runNumber = '${{ github.run_number }}';
          const runId = '${{ github.run_id }}';
          const repo = '${{ github.repository }}';
          
          const issueTitle = 'âš ï¸ åˆ†ææˆåŠŸä½†æ¨é€å¤±è´¥ - ' + today;
          const issueBody = '## âš ï¸ è‚¡ç¥¨åˆ†ææˆåŠŸï¼Œä½†Gitæ¨é€å¤±è´¥\n\n' +
            '**æ—¶é—´**: ' + today + '\n' +
            '**è¿è¡ŒID**: #' + runNumber + '\n\n' +
            '### âœ… æˆåŠŸéƒ¨åˆ†\n\n' +
            '- âœ… è‚¡ç¥¨åˆ†æå®Œæˆ\n' +
            '- âœ… æŠ¥å‘Šç”ŸæˆæˆåŠŸ\n' +
            '- âœ… æ–‡ä»¶ä¸Šä¼ åˆ°Artifacts\n\n' +
            '### âŒ å¤±è´¥éƒ¨åˆ†\n\n' +
            '- âŒ Gitæ¨é€åˆ°ä»“åº“å¤±è´¥ï¼ˆå¯èƒ½æ˜¯ä»£ç å†²çªï¼‰\n\n' +
            '### ğŸ“ è·å–æŠ¥å‘Š\n\n' +
            '- ğŸ“¦ [ä¸‹è½½åˆ†ææŠ¥å‘Š](https://github.com/' + repo + '/actions/runs/' + runId + ')\n' +
            '- ğŸ“‹ æŠ¥å‘Šå·²ç”Ÿæˆä½†æœªæ¨é€åˆ°ä»“åº“\n\n' +
            '### ğŸ”§ è§£å†³æ–¹æ¡ˆ\n\n' +
            '1. æ‰‹åŠ¨ä¸‹è½½æŠ¥å‘Šæ–‡ä»¶\n' +
            '2. ç­‰å¾…ä¸‹æ¬¡è‡ªåŠ¨è¿è¡Œï¼ˆå·²ä¼˜åŒ–æ¨é€é€»è¾‘ï¼‰\n' +
            '3. æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–è¿›ç¨‹åœ¨ä¿®æ”¹ä»“åº“\n\n' +
            '---\n\n' +
            '> ğŸ’¡ **è¯´æ˜**: è¿™ä¸å½±å“åˆ†æè´¨é‡ï¼ŒæŠ¥å‘Šä»å¯é€šè¿‡Artifactsä¸‹è½½ã€‚';

          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: issueTitle,
            body: issueBody,
            labels: ['âš ï¸ éƒ¨åˆ†å¤±è´¥', 'ğŸ¤– è‡ªåŠ¨ç”Ÿæˆ', 'ğŸ“Š åˆ†ææŠ¥å‘Š']
          });
          
          console.log('âœ… Gitæ¨é€å¤±è´¥é€šçŸ¥Issueåˆ›å»ºå®Œæˆ');